
<!DOCTYPE html>
<html>
<head>
  <title>Verfolger-Spiel – Joystick & 3D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: black;
      overflow: hidden;
      font-family: sans-serif;
      color: white;
    }
    canvas {
      display: block;
      background: #111;
      border: 2px solid #444;
      margin: 0 auto;
    }
    .overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
    }
    button {
      padding: 15px 30px;
      font-size: 18px;
      margin-top: 20px;
      background: limegreen;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: green;
    }
    #gameOverScreen, #levelCompleteScreen {
      display: none;
    }
    #joystick-container {
      position: absolute;
      bottom: 30px;
      left: 30px;
      width: 120px;
      height: 120px;
      background: radial-gradient(ellipse at center, #222 0%, #111 100%);
      border: 2px solid #666;
      border-radius: 50%;
      box-shadow: inset 0 4px 10px rgba(255, 255, 255, 0.05),
                  0 4px 12px rgba(0, 0, 0, 0.5);
      touch-action: none;
    }
    #joystick {
      width: 60px;
      height: 60px;
      background: radial-gradient(circle at 30% 30%, #66ff66, #228822);
      border-radius: 50%;
      position: absolute;
      top: 30px;
      left: 30px;
      box-shadow: inset 0 4px 6px rgba(255,255,255,0.3),
                  0 4px 10px rgba(0,0,0,0.6);
      touch-action: none;
    }
    #jump-button {
  position: absolute;
  bottom: 40px;
  right: 30px;
  width: 80px;
  height: 80px;
  background: radial-gradient(circle at 30% 30%, #99ff99, #005500);
  color: black;
  font-size: 24px;
  font-weight: bold;
  border-radius: 50%;
  border: 2px solid #003300;
  opacity: 0.95;
  box-shadow:
    inset 0 5px 10px rgba(255,255,255,0.4),
    0 8px 18px rgba(0,0,0,0.7),
    0 4px 6px rgba(0,255,0,0.4);
  transform-origin: center;
  transition: transform 0.1s ease, box-shadow 0.1s ease;

      position: absolute;
      bottom: 40px;
      right: 30px;
      width: 80px;
      height: 80px;
      background: radial-gradient(circle at 30% 30%, #66ff66, #228822);
      color: black;
      font-size: 24px;
      font-weight: bold;
      border-radius: 50%;
      border: none;
      opacity: 0.9;
      box-shadow:
        inset 0 3px 6px rgba(255,255,255,0.3),
        0 6px 12px rgba(0,0,0,0.6);
      transform-origin: center;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    #jump-button:active {
      transform: scaleY(0.6);
      box-shadow:
        inset 0 1px 2px rgba(0,0,0,0.3),
        0 2px 4px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <div id="startScreen" class="overlay">
    <h1>Verfolger-Spiel</h1>
    <button id="startButton">Start</button>
  </div>
  <div id="gameOverScreen" class="overlay">
    <h1>Game Over</h>
    <p id="finalScore"></p>
    <button id="restartButton">Erneut spielen</button>
  </div>
  <div id="levelCompleteScreen" class="overlay">
    <h1>Level geschafft!</h1>
    <p id="finalScoreWin"></p>
    <button onclick="location.reload()">Neustarten</button>
  </div>
  <canvas id="gameCanvas"></canvas>
  <div id="joystick-container" style="display:none;"><div id="joystick"></div></div>
  <button id="jump-button" style="display:none;">⤒</button>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const keys = {};
    const blocks = [];
const particles = [];

function spawnParticles(x, y) {
  for (let i = 0; i < 10; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 4,
      vy: (Math.random() - 0.5) * 4,
      life: 30,
      color: "orange"
    });
  }
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.2; // gravity
    p.life--;
    if (p.life <= 0) {
      particles.splice(i, 1);
    }
  }
}

function drawParticles() {
  for (let p of particles) {
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, 3, 3);
  }
}

    const joystick = { x: 0, active: false };
    
const destroySound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQgAAAAA'); // tiny placeholder

let player, chaser, gameRunning = false, gameLoopId, blockInterval, score = 0;
    let scoreInterval, levelTimer, teleporting = false, levelDuration = 60000;

    function resizeCanvas() {
      const aspect = 16 / 9;
      const width = window.innerWidth, height = window.innerHeight;
      canvas.width = width / height > aspect ? height * aspect : width;
      canvas.height = width / height > aspect ? height : width / aspect;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
    function getWallHeight() { return canvas.height / 8; }

    function resetGameState() {
      const wallHeight = getWallHeight();
      player = { x: canvas.width * 0.2, y: canvas.height - wallHeight - 20, width: 20, height: 20, color: "lime", speed: 3, velY: 0, jumpForce: 7, gravity: 0.4, grounded: false, visible: true, blocked: false };
      chaser = { x: canvas.width * 0.05, y: canvas.height - wallHeight - 20, width: 20, height: 20, color: "red", speed: 1.5 };
      blocks.length = 0; score = 0;
    }

    function spawnBlock() {
      if (!gameRunning) return;
      const wallHeight = getWallHeight();
      const width = Math.random() * 50 + 30;
      const height = Math.random() * 80 + 20;
      const y = Math.random() < 0.5 ? wallHeight : canvas.height - wallHeight - height;
      blocks.push({ x: canvas.width, y, width, height, color: "#888", speed: 2 });
    }

    function drawWalls() {
      const wallHeight = getWallHeight();
      ctx.fillStyle = "#444";
      ctx.fillRect(0, 0, canvas.width, wallHeight);
      ctx.fillRect(0, canvas.height - wallHeight, canvas.width, wallHeight);
    }

    function drawRect(obj) {
  if (obj.visible === false) return;

  // Main face
  ctx.fillStyle = obj.color || "#888";
  ctx.fillRect(obj.x, obj.y, obj.width, obj.height);

  // 3D shading
  ctx.fillStyle = "#333";
  ctx.beginPath();
  ctx.moveTo(obj.x + obj.width, obj.y);
  ctx.lineTo(obj.x + obj.width + 6, obj.y - 6);
  ctx.lineTo(obj.x + obj.width + 6, obj.y + obj.height - 6);
  ctx.lineTo(obj.x + obj.width, obj.y + obj.height);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "#aaa";
  ctx.beginPath();
  ctx.moveTo(obj.x, obj.y);
  ctx.lineTo(obj.x + 6, obj.y - 6);
  ctx.lineTo(obj.x + obj.width + 6, obj.y - 6);
  ctx.lineTo(obj.x + obj.width, obj.y);
  ctx.closePath();
  ctx.fill();

  // subtle shadow
  ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
  ctx.shadowBlur = 8;
  ctx.shadowOffsetX = 4;
  ctx.shadowOffsetY = 4;

      if (obj.visible === false) return;
      const gradient = ctx.createLinearGradient(obj.x, obj.y, obj.x + obj.width, obj.y + obj.height);
      gradient.addColorStop(0, "#bbb");
      gradient.addColorStop(1, obj.color || "#888");
      ctx.fillStyle = gradient;
      ctx.shadowColor = "rgba(0, 0, 0, 0.4)";
      ctx.shadowBlur = 6;
      ctx.shadowOffsetX = 3;
      ctx.shadowOffsetY = 3;
      ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
      ctx.shadowColor = "transparent";
    }

    function drawScore() {
      ctx.fillStyle = "white";
      ctx.font = "16px Arial";
      ctx.fillText("Punkte: " + score, 10, 30);
    }

    function movePlayer() {
      const wallHeight = getWallHeight();
      if (keys["a"]) player.x -= player.speed;
      if (keys["d"]) player.x += player.speed;
      if (keys["w"] && player.grounded) {
        player.velY = -player.jumpForce;
        player.grounded = false;
        keys["w"] = false;
      }
      player.velY += player.gravity;
      player.y += player.velY;
      const floorY = canvas.height - wallHeight - player.height;
      if (player.y > floorY) {
        player.y = floorY;
        player.velY = 0;
        player.grounded = true;
      }
    }

    function moveChaser() {
      const dx = player.x - chaser.x;
      const dy = player.y - chaser.y;
      const dist = Math.hypot(dx, dy);
      if (dist > (player.blocked ? 1 : 60)) {
        chaser.x += (dx / dist) * chaser.speed;
        chaser.y += (dy / dist) * chaser.speed;
      }
    }

    function moveBlocks() { for (let block of blocks) block.x -= block.speed; }

    
function destroyBlocksOnContact(chaser) {
  for (let i = blocks.length - 1; i >= 0; i--) {
    const block = blocks[i];
    const collided = chaser.x < block.x + block.width &&
                     chaser.x + chaser.width > block.x &&
                     chaser.y < block.y + block.height &&
                     chaser.y + chaser.height > block.y;
    if (collided) {
      // Simple destroy animation placeholder (e.g. flicker)
      let flashes = 4;
      const flashInterval = setInterval(() => {
        block.visible = !block.visible;
        if (--flashes <= 0) {
          clearInterval(flashInterval);
          spawnParticles(block.x + block.width/2, block.y + block.height/2);
          destroySound.play();
          blocks.splice(i, 1);
        }
      }, 60);
    }
  }
}


function checkBlockCollisions(entity) {
  entity.grounded = false;
  entity.blocked = false;
  const wallHeight = getWallHeight();
  let onSomething = false;

  for (let block of blocks) {
    const collided = entity.x < block.x + block.width &&
                     entity.x + entity.width > block.x &&
                     entity.y < block.y + block.height &&
                     entity.y + entity.height > block.y;
    if (collided) {
      entity.blocked = true;

      const fromTop = entity.y + entity.height - entity.velY <= block.y;
      const fromBottom = entity.y - entity.velY >= block.y + block.height;
      const fromLeft = entity.x + entity.width / 2 < block.x + block.width / 2;

      if (fromTop) {
        entity.y = block.y - entity.height;
        entity.velY = 0;
        onSomething = true;
      } else if (fromBottom) {
        entity.y = block.y + block.height;
        entity.velY = 0;
      } else if (fromLeft) {
        entity.x = block.x - entity.width;
      } else {
        entity.x = block.x + block.width;
      }
    }
  }

  if (entity.y < wallHeight) {
    entity.y = wallHeight;
    entity.velY = 0;
  }

  const floor = canvas.height - wallHeight - entity.height;
  if (entity.y >= floor) {
    entity.y = floor;
    entity.velY = 0;
    onSomething = true;
  }

  entity.grounded = onSomething;
}

        }
      }
      if (entity.y < wallHeight) entity.y = wallHeight;
      if (entity.y > canvas.height - wallHeight - entity.height) {
        entity.y = canvas.height - wallHeight - entity.height;
        entity.velY = 0;
        entity.grounded = true;
      }
    }

    function checkGameOver() {
      if (player.x < chaser.x + chaser.width &&
          player.x + player.width > chaser.x &&
          player.y < chaser.y + chaser.height &&
          player.y + player.height > chaser.y) {
        endGame();
      }
    }

    function endGame() {
      gameRunning = false;
      cancelAnimationFrame(gameLoopId);
      clearInterval(blockInterval);
      clearInterval(scoreInterval);
      clearTimeout(levelTimer);
      document.getElementById("finalScore").innerText = "Deine Punkte: " + score;
      document.getElementById("gameOverScreen").style.display = "flex";
    }

    function levelWon() {
      teleporting = true;
      let flashes = 6;
      const flashInterval = setInterval(() => {
        player.visible = !player.visible;
        if (--flashes <= 0) {
          clearInterval(flashInterval);
          player.visible = false;
          finishLevel();
        }
      }, 200);
    }

    function finishLevel() {
      gameRunning = false;
      cancelAnimationFrame(gameLoopId);
      clearInterval(blockInterval);
      clearInterval(scoreInterval);
      document.getElementById("finalScoreWin").innerText = "Deine Punkte: " + score;
      document.getElementById("levelCompleteScreen").style.display = "flex";
    }

    function gameLoop() {
      if (!gameRunning) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawWalls();
      movePlayer();
      moveChaser();
      moveBlocks();
      checkBlockCollisions(player);
      checkBlockCollisions(chaser);
      updateParticles();
      destroyBlocksOnContact(chaser);
      drawRect(player);
      drawRect(chaser);
      for (let block of blocks) drawRect(block);
      drawParticles();
      drawScore();
      if (!teleporting) checkGameOver();
      gameLoopId = requestAnimationFrame(gameLoop);
    }

    document.addEventListener("keydown", (e) => keys[e.key.toLowerCase()] = true);
    document.addEventListener("keyup", (e) => keys[e.key.toLowerCase()] = false);
    document.getElementById("startButton").addEventListener("click", () => {
      document.getElementById("startScreen").style.display = "none";
      resetGameState(); teleporting = false; gameRunning = true;
      blockInterval = setInterval(spawnBlock, 1500);
      scoreInterval = setInterval(() => score++, 100);
      levelTimer = setTimeout(() => { if (gameRunning) levelWon(); }, levelDuration);
      gameLoop();
    });
    document.getElementById("restartButton").addEventListener("click", () => {
      document.getElementById("gameOverScreen").style.display = "none";
      resetGameState(); teleporting = false; gameRunning = true;
      blockInterval = setInterval(spawnBlock, 1500);
      scoreInterval = setInterval(() => score++, 100);
      levelTimer = setTimeout(() => { if (gameRunning) levelWon(); }, levelDuration);
      gameLoop();
    });

    // Touch
    const joystickEl = document.getElementById("joystick");
    joystickEl.addEventListener("touchstart", e => { joystick.active = true; joystick.x = e.touches[0].clientX; });
    joystickEl.addEventListener("touchmove", e => {
      const dx = e.touches[0].clientX - joystick.x;
      keys["a"] = dx < -20;
      keys["d"] = dx > 20;
    });
    joystickEl.addEventListener("touchend", () => { keys["a"] = keys["d"] = false; });

    const jumpButton = document.getElementById("jump-button");
    jumpButton.addEventListener("touchstart", () => keys["w"] = true);
    jumpButton.addEventListener("touchend", () => keys["w"] = false);

    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      document.getElementById("joystick-container").style.display = "block";
      jumpButton.style.display = "block";
    }

    resetGameState();
  </script>
</body>
</html>
